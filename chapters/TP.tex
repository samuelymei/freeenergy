% !TeX spellcheck = en_US
\subsection{Thermodynamic Perturbation\label{Sec:FEM:TP}}
Thermodynamic Perturbation (TP), also known as Free Energy Perturbation (FEP), exponential average, or Zwanzig equation was developed by Zwanzig,\cite{ZwanzigJCP1954} and Landau and Lifshitz, independently, and probably by Peierls\cite{JorgensenJCTC2008}. 

A reference system containing $N$-particles can be described by Hamiltonian $H_{0}(\mathbf{x},\mathbf{p}_{x})$, which is a function of $3N$ Cartesian coordinates, $\mathbf{x}$, and their conjugated momenta, $\mathbf{p}_{x}$. Similarly, the target system can be described by Hamiltonian $H_{1}(\mathbf{x},\mathbf{p}_{x})$. These two systems are connected by 
\begin{equation}
H_{1}(\mathbf{x},\mathbf{p}_{x}) = H_{0}(\mathbf{x},\mathbf{p}_{x}) + \Delta H (\mathbf{x},\mathbf{p}_{x})
\label{Eq:FEM:TP:deltaH}
\end{equation}
The Helmholtz free energy difference between the target and the reference systems, $\Delta A$, can be given in terms of the ratio of the corresponding partition functions, $Q_{1}$ and $Q_{0}$:
\begin{equation}
\Delta A  =  -\frac{1}{\beta}\ln\frac{Q_{1}}{Q_{0}},
\label{Eq:FEM:TP:deltaA}
\end{equation}
where $\beta = {(k_{B}T)}^{-1}$, and
\begin{equation}
Q = \frac{1}{{h}^{3N}N!} \iint \exp\left[-\beta H(\mathbf{x},\mathbf{p}_{x})\right] d\mathbf{x}d\mathbf{p}_\mathbf{x}.
\label{Eq:FEM:TP:PF}
\end{equation}
Taking Eq.~\ref{Eq:FEM:TP:PF} into Eq.~\ref{Eq:FEM:TP:deltaA}, we obtain
\begin{align}
\Delta A  =&  -\frac{1}{\beta}\ln{\frac{\iint \exp\left[-\beta H_{1}(\mathbf{x},\mathbf{p}_{x})\right] d\mathbf{x}d\mathbf{p}_\mathbf{x}}{\iint \exp\left[-\beta H_{0}(\mathbf{x},\mathbf{p}_{x}) \right] d\mathbf{x}d\mathbf{p}_\mathbf{x}}}\\
=& -\frac{1}{\beta}\ln{\frac{\iint \exp\left[-\beta \Delta H(\mathbf{x},\mathbf{p}_{x})\right] \exp\left[-\beta H_{0}(\mathbf{x},\mathbf{p}_{x})\right] d\mathbf{x}d\mathbf{p}_\mathbf{x}}{\iint \exp\left[-\beta H_{0}(\mathbf{x},\mathbf{p}_{x})\right] d\mathbf{x}d\mathbf{p}_\mathbf{x}}},
\label{Eq:FEM:TP:deltaA2}
\end{align}
The probability density function of finding the reference system in a state defined by positions $\mathbf{x}$ and momenta $\mathbf{p}_{x}$ is 
\begin{equation}
P_{0}(\mathbf{x},\mathbf{p}_{x}) = \frac{ \exp[-\beta H_{0}(\mathbf{x},\mathbf{p}_{x}) ] }{\iint \exp[-\beta H_{0}(\mathbf{x},\mathbf{p}_{x}) ] d\mathbf{x}d\mathbf{p}_\mathbf{x}}
\label{Eq:FEM:TP:proden}
\end{equation}
If the probability density function is used, Eq.~\ref{Eq:FEM:TP:deltaA2} becomes
\begin{equation}
\Delta A = -\frac{1}{\beta} \iint \exp[-\beta \Delta H(\mathbf{x},\mathbf{p}_{x})] P_{0}(\mathbf{x},\mathbf{p}_{x}) d\mathbf{x}d\mathbf{p}_\mathbf{x},
\label{Eq:FEM:TP:deltaA3}
\end{equation}
or, equivalently,
\begin{equation}
\Delta A = -\frac{1}{\beta} \ln{\langle \exp{\left[-\beta \Delta H(\mathbf{x},\mathbf{p}_{x})\right]} \rangle_{0}},
\label{Eq:FEM:TP:deltaA4}
\end{equation}
Here, $\left \langle \cdots \right \rangle _{0}$ denotes an ensemble average over configurations sampled from the reference state. Equation~\ref{Eq:FEM:TP:deltaA4} is the basic equation of TP. It states that $\Delta A$ can be estimated by sampling only equilibrium configurations of the reference state.

Note that integration over the kinetic term in the partition function, Eq.~\ref{Eq:FEM:TP:PF}, can be carried out analytically. Thus, it cancels out in Eq.~\ref{Eq:FEM:TP:deltaA}, and Eq.~\ref{Eq:FEM:TP:deltaA4} becomes
\begin{equation}
\Delta A = -\frac{1}{\beta} \ln{\left< \exp(-\beta \Delta U) \right>_{0}},
\label{Eq:FEM:TP:deltaA5}
\end{equation}
where $\Delta U$ is the difference in the potential energy between the target and the reference states. The integration implied by the statistical average is now carried out over particle coordinates only.

If we reverse the reference and the target systems, and repeat the same derivation, using the same convention for  $\Delta A$ and $\Delta U$ as before, we obtain
\begin{equation}
\Delta A = \frac{1}{\beta} \ln{ \left \langle \exp(\beta \Delta U) \right \rangle_{1}},
\label{Eq:FEM:TP:deltaA6}
\end{equation}
Although expressions Eq.~\ref{Eq:FEM:TP:deltaA5} and Eq.~\ref{Eq:FEM:TP:deltaA6} are formally equivalent, their convergence properties may be quite different. This means that there is a preferred direction to carry out the required transformation between the two states. One should start the perturbation from the state having larger important region in phase space. This means that the reference system should be that with higher entropy, and the transformation should proceed in the direction in which the entropy decreases. 

Equation~\ref{Eq:FEM:TP:deltaA5} and Eq.~\ref{Eq:FEM:TP:deltaA6}, are formally exact for any perturbation. However, this does not mean that they can always be successfully applied. Since $\Delta A$ is calculated as the average over a quantity that depends only on $\Delta U$, this average can be computed over probability distribution $P_0(\Delta U)$ instead of $P_{0}(\mathbf{x},\mathbf{p}_{x})$. Then, $\Delta A$ in Eq.~\ref{Eq:FEM:TP:deltaA3} can be expressed as a one-dimensional integral over energy difference
\begin{equation}
\Delta A = -\frac{1}{\beta} \int \exp(-\beta \Delta U) P_{0}(\Delta U) d\Delta U,
\label{Eq:FEM:TP:deltaA7}
\end{equation}
If $U_{0}$ and $U_{1}$ were the functions of a sufficient number of identically distributed random variable, $\Delta U$ would follow a Gaussian distribution, which is a consequence of the central limit theorem. In practice, the probability distribution $P_{0}(\Delta U)$ deviates somewhat from the ideal Gaussian case, but still has a ``Gaussian-like'' shape. This indicates that the value of the integral in Eq.~\ref{Eq:FEM:TP:deltaA7} depends on the low-energy tail of the distribution.

Even though $P_{0}(\Delta U)$ is only rarely an exact Gaussian, it is instructive to consider this case in more detail. 
\begin{figure}
	\centering
	\begin{tikzpicture}
	\def\lims{xmin=-6.5,xmax=3,ymin=0.0,ymax=40}
	\begin{axis}[\lims,
	xtick=\empty, ytick=\empty, minor tick num=0, 
	xlabel=$\Delta U$,
	ylabel={$P$},
	%ytick={0,10,...,40},
	]
	% use TeX as calculator:
	\addplot[thick,color=red,domain=-4:2,samples=500] {5*exp(-(x+1)*(x+1)/2)};
	\addplot[thick,color=blue,samples=500,domain=-4:2] {exp(-1.2*x)};
	\addplot[thick,color=black,samples=500,domain=-6:3] {exp(-1.2*x)*5*exp(-(x+1)*(x+1)/2)};
	\draw[thick,red,->,>=stealth] (axis cs:0.5,2.2) to (axis cs:1.5,5.0);
	\draw[thick,blue,->,>=stealth] (axis cs:-3,33) to (axis cs:-4,36);
	\draw[thick,black,->,>=stealth] (axis cs:-1,20) to (axis cs:0.1,25);
	\draw[red] (axis cs:1.5,6.5) node{\scriptsize$P_0(\Delta U)$};
	\draw[blue] (axis cs:-4.6,37.3) node{\scriptsize$\exp{(-\beta \Delta U)}$};
	\draw[black] (axis cs:0.8,26.5) node{\scriptsize$P_0(\Delta U)\ast \exp{(-\beta \Delta U)}$};
	\end{axis}
	\end{tikzpicture}
	\caption{$P_{0}(\Delta U)$, the Boltzmann factor $\exp(-\beta \Delta U)$ and their product, which is the integrand in \ref{Eq:FEM:TP:deltaA7}. The low-$\Delta U$ tail of the integrand is poorly sampled with $P_{0}(\Delta U)$ and, therefore, is known with low statistical accuracy. However, it provides an important contribution to the integral.}\label{Fig:TP:Pdistribution}
\end{figure}

%\begin{figure}[htbp]
%	\centering
%	\includegraphics[width=0.6\textwidth]{figures/TP.pdf}\\
%\caption{$P_{0}(\Delta U)$, the Boltzmann factor $\exp(-\beta \Delta U)$ and their product, which is the integrand in \ref{Eq:FEM:TP:deltaA7}. The low-$\Delta U$ tail of the integrand is poorly sampled with $P_{0}(\Delta U)$ and, therefore, is known with low statistical accuracy. However, it provides an important contribution to the integral.}\label{Fig:TP:Pdistribution}
%\end{figure}
If we substitute
\begin{equation}
P_{0}(\Delta U) = \frac{1}{\sqrt{2\pi}\sigma}\exp{\left[-\frac{(\Delta U - \left \langle \Delta U \right \rangle_{0})^2}{2\sigma^2}\right]}
\label{Eq:FEM:TP:gaussian}
\end{equation}
where
\begin{equation}
\sigma^2 = \left \langle \Delta U^2 \right \rangle_{0} - \left \langle \Delta U \right \rangle_{0}^2
\label{Eq:FEM:TP:variance}
\end{equation}
to Eq.~\ref{Eq:FEM:TP:deltaA7}, we obtain
\begin{equation}
\exp(-\beta \Delta A) = \frac{C}{\sqrt{2\pi}\sigma} \int \exp{\left[-\frac{(\Delta U - \left \langle \Delta U \right \rangle_{0} - \beta \sigma ^2)^2}{2\sigma^2}\right]} d\Delta U
\label{Eq:FEM:TP:expdeltaA}
\end{equation}
Here, $C$ is independent of $\Delta U$
\begin{equation}
C = \exp{\left[-\beta (\left \langle \Delta U \right \rangle_{0} - \frac{1}{2} \beta \sigma ^2)\right]}
\label{Eq:FEM:TP:C}
\end{equation}
If $P_{0}(\Delta U)$ is Gaussian, the integral in Eq.~\ref{Eq:FEM:TP:expdeltaA} can be evaluated analytically using cumulant expansion
\begin{equation}
\Delta A = \left< \Delta U \right>_{0} - \frac{1}{2} \beta \sigma ^2.
\label{Eq:FEM:TP:deltaA8}
\end{equation}
If the distribution of $\Delta U$ deviates from Gaussian, there will be extra terms measuring the skewness of Gaussian. With the leading term, $\Delta A$ becomes
\begin{equation}
\Delta A = \left< \Delta U \right>_{0} - \frac{1}{2} \beta \sigma ^2 + \frac{\beta^2}{6} \left(\left<\Delta U^3\right>_0-3\left<\Delta U^2\right>_0\left<\Delta U\right>_0+2\left<\Delta U\right>_0^3\right).
\label{Eq:FEM:TP:deltaA9}
\end{equation}
The overlap matrix~\cite{KlimovichJCAMD2015} is a useful metric in characterizing the magnitude of overlap in the phase space. It is recommended to be used as a consistency check, as in the case of the TP-based methods. If the weight of each of the $N$ samples $x_{n}$ (collected from all $K$ states) in the $i$th state as:
\begin{equation}
W_{n,i}(x_{n}) = \frac{e^{\beta G_{i} - \beta U_{i}(x_{n})}}{\sum_{k=1}^{K} N_{k}e^{\beta G_{k}-\beta U_{k}(x_{n})}}
\label{Eq:FEM:TP:weights}
\end{equation}
Then, the overlap matrix is a $K \times K$ matrix with entries:
\begin{equation}
O_{i,j} = \sum_{n=1}^{N}\frac{N_{i} e^{\beta G_{i} - \beta U_{i}(x_{n})}}{\sum_{k=1}^{K} N_{k}e^{\beta G_{k}-\beta U_{k}(x_{n})}}\frac{e^{\beta G_{j} - \beta U_{j}(x_{n})}}{\sum_{l=1}^{L} N_{l}e^{\beta G_{l}-\beta U_{l}(x_{n})}}
\label{Eq:FEM:TP:om}
\end{equation}
